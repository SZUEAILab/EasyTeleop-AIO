name: Release offline docker tars

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v1.2.3). If empty, uses the ref name."
        required: false
        type: string
      image_repo:
        description: "Image repo prefix inside tar (default: easyteleop)"
        required: false
        type: string
      push_packages:
        description: "Push multi-arch images to GitHub Packages (GHCR)"
        required: false
        type: boolean
        default: false
      package_image_repo:
        description: "Image repo for pushed packages (default: ghcr.io/<owner>/easyteleop)"
        required: false
        type: string

permissions:
  contents: write
  packages: write

jobs:
  prepare-release:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.vars.outputs.tag }}
      image_repo: ${{ steps.vars.outputs.image_repo }}
      repo_slug: ${{ steps.vars.outputs.repo_slug }}
      push_packages: ${{ steps.vars.outputs.push_packages }}
      package_image_repo: ${{ steps.vars.outputs.package_image_repo }}
    steps:
      - name: Set vars
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG_INPUT="${{ inputs.tag }}"
          if [[ -z "${TAG_INPUT}" ]]; then
            TAG_INPUT="${GITHUB_REF_NAME}"
          fi
          echo "tag=${TAG_INPUT}" >> "$GITHUB_OUTPUT"

          IMAGE_REPO_INPUT="${{ inputs.image_repo }}"
          if [[ -z "${IMAGE_REPO_INPUT}" ]]; then
            IMAGE_REPO_INPUT="easyteleop"
          fi
          echo "image_repo=${IMAGE_REPO_INPUT}" >> "$GITHUB_OUTPUT"

          repo_slug="$(echo "${IMAGE_REPO_INPUT}" | sed -E 's#[^A-Za-z0-9_.-]+#_#g')"
          echo "repo_slug=${repo_slug}" >> "$GITHUB_OUTPUT"

          PUSH_PACKAGES="false"
          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            PUSH_PACKAGES="true"
          else
            if [[ "${{ inputs.push_packages }}" == "true" ]]; then
              PUSH_PACKAGES="true"
            fi
          fi
          echo "push_packages=${PUSH_PACKAGES}" >> "$GITHUB_OUTPUT"

          PACKAGE_IMAGE_REPO_INPUT="${{ inputs.package_image_repo }}"
          if [[ -z "${PACKAGE_IMAGE_REPO_INPUT}" ]]; then
            PACKAGE_IMAGE_REPO_INPUT="ghcr.io/${GITHUB_REPOSITORY_OWNER}/easyteleop"
          fi
          echo "package_image_repo=${PACKAGE_IMAGE_REPO_INPUT}" >> "$GITHUB_OUTPUT"

      - name: Create/Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.vars.outputs.tag }}
          name: Offline docker tars ${{ steps.vars.outputs.tag }}

  build-and-upload:
    needs: prepare-release
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - image: backend
            context: ./EasyTeleop-Backend-Python
            dockerfile: Dockerfile
            build_args: ""
          - image: node
            context: ./EasyTeleop-Node
            dockerfile: Dockerfile
            build_args: ""
          - image: hdf5
            context: ./HDF5DataVisualize
            dockerfile: Dockerfile
            build_args: ""
          - image: frontend
            context: ./EasyTeleopFrontend
            dockerfile: Dockerfile
            build_args: >-
              --build-arg NEXT_PUBLIC_API_URL=/api
              --build-arg NEXT_PUBLIC_MQTT_URL=
              --build-arg NEXT_PUBLIC_MQTT_USERNAME=admin
              --build-arg NEXT_PUBLIC_MQTT_PASSWORD=public
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare output directory
        shell: bash
        run: |
          set -euo pipefail
          sudo mkdir -p /mnt/dist
          sudo chown -R "$(id -u)":"$(id -g)" /mnt/dist

      - name: Build and export (${{ matrix.image }})
        shell: bash
        run: |
          set -euo pipefail
          IMAGE_REPO="${{ needs.prepare-release.outputs.image_repo }}"
          RELEASE_TAG="${{ needs.prepare-release.outputs.tag }}"
          IMAGE_TAG="latest"
          REPO_SLUG="${{ needs.prepare-release.outputs.repo_slug }}"
          IMAGE="${{ matrix.image }}"
          CONTEXT="${{ matrix.context }}"
          DOCKERFILE="${{ matrix.dockerfile }}"

          for arch in amd64 arm64; do
            out="/mnt/dist/${REPO_SLUG}-${IMAGE}-${RELEASE_TAG}-${arch}.tar"
            docker buildx build \
              --platform "linux/${arch}" \
              -t "${IMAGE_REPO}/${IMAGE}:${IMAGE_TAG}" \
              -f "${CONTEXT}/${DOCKERFILE}" \
              ${{ matrix.build_args }} \
              --output "type=docker,dest=${out}" \
              "${CONTEXT}"
          done

      - name: Checksums (${{ matrix.image }})
        shell: bash
        run: |
          set -euo pipefail
          RELEASE_TAG="${{ needs.prepare-release.outputs.tag }}"
          REPO_SLUG="${{ needs.prepare-release.outputs.repo_slug }}"
          IMAGE="${{ matrix.image }}"
          (cd /mnt/dist && sha256sum "${REPO_SLUG}-${IMAGE}-${RELEASE_TAG}-"*.tar > "SHA256SUMS-${IMAGE}.txt")

      - name: Upload workflow artifact (${{ matrix.image }})
        uses: actions/upload-artifact@v4
        with:
          name: offline-tars-${{ needs.prepare-release.outputs.tag }}-${{ matrix.image }}
          path: |
            /mnt/dist/${{ needs.prepare-release.outputs.repo_slug }}-${{ matrix.image }}-${{ needs.prepare-release.outputs.tag }}-*.tar
            /mnt/dist/SHA256SUMS-${{ matrix.image }}.txt

      - name: Upload release assets (${{ matrix.image }})
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag }}
          name: Offline docker tars ${{ needs.prepare-release.outputs.tag }}
          files: |
            /mnt/dist/${{ needs.prepare-release.outputs.repo_slug }}-${{ matrix.image }}-${{ needs.prepare-release.outputs.tag }}-*.tar
            /mnt/dist/SHA256SUMS-${{ matrix.image }}.txt

  push-packages:
    needs: prepare-release
    if: ${{ needs.prepare-release.outputs.push_packages == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        if: ${{ startsWith(needs.prepare-release.outputs.package_image_repo, 'ghcr.io/') }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push multi-arch images
        shell: bash
        env:
          IMAGE_REPO: ${{ needs.prepare-release.outputs.package_image_repo }}
          TAG: ${{ needs.prepare-release.outputs.tag }}
          NEXT_PUBLIC_API_URL: /api
          NEXT_PUBLIC_MQTT_URL: ""
          NEXT_PUBLIC_MQTT_USERNAME: admin
          NEXT_PUBLIC_MQTT_PASSWORD: public
        run: |
          set -euo pipefail
          docker buildx bake -f docker-bake.hcl multi --push
