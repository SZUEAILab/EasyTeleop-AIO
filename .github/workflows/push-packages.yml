name: Push multi-arch images to GHCR

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Image tag (e.g. v1.2.3). If empty, uses the ref name."
        required: false
        type: string
      package_image_repo:
        description: "Image repo for pushed packages (default: ghcr.io/<owner>/easyteleop)"
        required: false
        type: string

permissions:
  contents: read
  packages: write

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.vars.outputs.tag }}
      package_image_repo: ${{ steps.vars.outputs.package_image_repo }}
    steps:
      - name: Set vars
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          TAG_INPUT="${{ inputs.tag }}"
          if [[ -z "${TAG_INPUT}" ]]; then
            TAG_INPUT="${GITHUB_REF_NAME}"
          fi
          echo "tag=${TAG_INPUT}" >> "$GITHUB_OUTPUT"

          PACKAGE_IMAGE_REPO_INPUT="${{ inputs.package_image_repo }}"
          if [[ -z "${PACKAGE_IMAGE_REPO_INPUT}" ]]; then
            PACKAGE_IMAGE_REPO_INPUT="ghcr.io/${GITHUB_REPOSITORY_OWNER}/easyteleop"
          fi
          PACKAGE_IMAGE_REPO_INPUT="$(echo "${PACKAGE_IMAGE_REPO_INPUT}" | tr '[:upper:]' '[:lower:]')"
          echo "package_image_repo=${PACKAGE_IMAGE_REPO_INPUT}" >> "$GITHUB_OUTPUT"

  push:
    needs: prepare
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        if: ${{ startsWith(needs.prepare.outputs.package_image_repo, 'ghcr.io/') }}
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push multi-arch images
        shell: bash
        env:
          IMAGE_REPO: ${{ needs.prepare.outputs.package_image_repo }}
          TAG: ${{ needs.prepare.outputs.tag }}
          NEXT_PUBLIC_API_URL: /api
          NEXT_PUBLIC_MQTT_URL: ""
          NEXT_PUBLIC_MQTT_USERNAME: admin
          NEXT_PUBLIC_MQTT_PASSWORD: public
        run: |
          set -euo pipefail
          docker buildx bake -f docker-bake.hcl multi --push

      - name: Tag the pushed images as latest (no rebuild)
        shell: bash
        env:
          IMAGE_REPO: ${{ needs.prepare.outputs.package_image_repo }}
          TAG: ${{ needs.prepare.outputs.tag }}
        run: |
          set -euo pipefail
          for image in backend node frontend hdf5; do
            docker buildx imagetools create \
              -t "${IMAGE_REPO}/${image}:latest" \
              "${IMAGE_REPO}/${image}:${TAG}"
          done
